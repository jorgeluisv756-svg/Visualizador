<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Visualizador de Municipios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; width: 100%; }

    #logo {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 9999;
      background: rgba(255, 255, 255, 0.7);
      padding: 5px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #logo img {
      width: 360px;
      height: auto;
      display: block;
      max-width: 90vw;
    }

    #panel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      font-size: 0.9em;
      width: 90vw;
      max-width: 280px;
    }
    #panel h3 { margin-top: 0; font-size: 14px; text-align: center; }

    #etiquetas-panel {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      font-size: 0.9em;
      width: 90vw;
      max-width: 180px;
    }
    #etiquetas-panel h3 {
      margin-top: 0;
      font-size: 13px;
      text-align: center;
    }

    #legend {
      margin-top: 10px;
      font-size: 12px;
      display: none;
    }
    #legend div {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    #legend span {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-right: 6px;
    }

    /* Etiquetas en pane dedicado */
    .region-label {
      font-size: 15px;
      font-weight: bold;
      color: #000;
      text-align: center;
      background: rgba(255,255,255,0.6);
      padding: 2px 4px;
      border-radius: 3px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .mun-label {
      font-size: 10px;
      max-width: 120px;
      white-space: normal;
      font-weight: bold;
      word-wrap: break-word;
      color: #000;
      background: none;
      text-align: center;
      box-shadow: none;
      text-align: center;
      box-shadow: none;
      text-shadow:
        1px 1px 2px #fff,
       -1px 1px 2px #fff,
        1px -1px 2px #fff,
       -1px -1px 2px #fff;
    }

    .empty-icon {
      background: none;
      border: none;
    }

    #simbolos-panel {
      position: absolute;
      bottom: 10px; 
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      font-size: 0.9em;
      width: 90vw;
      max-width: 180px;
    }
    #simbolos-panel h3 {
      margin-top: 0;
      font-size: 13px;
      text-align: center;
    }
    .simbolo .box {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-right: 6px;
      background: none;      /* sin relleno */
      border: 2px solid;     /* solo contorno */
    }

    .simbolo .municipio { border-color: #999; }
    .simbolo .region { border-color: #000; }
    .simbolo .estado { border-color: rgb(255,0,0); }


    @media (max-width: 600px) {
      #logo img { width: 200px; }
      #panel,
      #etiquetas-panel{
        bottom: 120px;
        right: 10px;
      }
      #simbolos-panel {
        bottom: 10px;
        right: 10px;
        width: 90vw;
        font-size: 0.85em;
        padding: 8px;
      }

      .region-label {
        font-size: 11px;
        padding: 1px 3px;
      }

      .mun-label {
        font-size: 9px;
        padding: 1px 2px;
      }

      .simbolo .box {
        width: 16px;
        height: 16px;
        margin-right: 4px;
      }

      .simbolo .line {
        width: 24px;
        border-top-width: 2px;
      }
    }
  </style>
</head>
<body>
  <div id="logo">
    <img src="https://raw.githubusercontent.com/jorgeluisv756-svg/imagenes_kmz/7c7924c0d0c89c5adaf112d1b8e3fb9db3258400/Logotipo%20armas30%20(1).png" alt="Logo Institucional">
  </div>

  <div id="panel">
    <h3>Selecciona mapa</h3>
    <label><input type="radio" name="mapOption" value="informe1"> Tu Experiencia Transforma 1er Informe</label><br>
    <label><input type="radio" name="mapOption" value="informe2"> Tu Experiencia Transforma 2do Informe</label>
    <div id="legend"><strong>INVERSIÓN</strong></div>
  </div>

  <div id="etiquetas-panel">
    <h3>Selecciona etiquetas</h3>
    <label><input type="checkbox" id="toggleMunicipios" checked> Municipales</label><br>
    <label><input type="checkbox" id="toggleRegiones" checked> Regionales</label>
  </div>

  <div id="simbolos-panel">
    <h3>Simbología</h3>
    <div class="simbolo">
      <span class="box municipio"></span> Municipio
    </div>
    <div class="simbolo">
      <span class="box region"></span> Región
   </div>
    <div class="simbolo">
      <span class="box estado"></span> Estado de Hidalgo
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Inicializar mapa
    var map = L.map('map').setView([20.1, -98.7], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Pane para etiquetas por encima de todo, sin capturar eventos
    map.createPane('labels');
    map.getPane('labels').style.zIndex = 650;
    map.getPane('labels').style.pointerEvents = 'none';

    // Capas base y grupos de etiquetas
    var municipiosLayer, regionesLayer, edoLayer;
    var informe1Layer, informe2Layer, informesData;
    var regionesLabelLayer = L.layerGroup([], { pane: 'labels' }).addTo(map);
    var municipiosLabelLayer = L.layerGroup([], { pane: 'labels' }).addTo(map);

    // Municipios con etiquetas NOMGEO
    fetch('Municipios.geojson')
      .then(res => res.json())
      .then(data => {
        municipiosLayer = L.geoJSON(data, {
           style: { color: "#999", weight: 1, fillOpacity: 0 }
         }).addTo(map);

         L.geoJSON(data, {
           onEachFeature: function(feature, layer) {
             var center = layer.getBounds().getCenter();
             var label = getField({ properties: feature.properties }, "NOMGEO");
             if (!label || !center) return;
             L.marker(center, {
             pane: 'labels',
             interactive: false,
             icon: L.divIcon({ className: 'empty-icon' })
        })
             .bindTooltip(String(label), {
             permanent: true,
             direction: "center",
             className: "mun-label"
        })
         .addTo(municipiosLabelLayer);
         },
         style: { opacity: 0, fillOpacity: 0 }
       });
     });

    // Regiones con etiquetas del campo "Regiones" (prioridad, centrado)
    fetch('Regiones.geojson')
      .then(res => res.json())
      .then(data => {
        regionesLayer = L.geoJSON(data, {
          style: { color: "#000", weight: 2, fillOpacity: 0, dashArray: "1,6,1,6" }
        }).addTo(map);

        L.geoJSON(data, {
          onEachFeature: function(feature, layer) {
            if (!feature || !feature.properties) return;
            var title = getField({ properties: feature.properties }, "Regiones");
            if (!title) return;
            var center = layer.getBounds ? layer.getBounds().getCenter() : null;
            if (!center) return;
            L.marker(center, {
  	    pane: 'labels',
	    interactive: false,
  	    icon: L.divIcon({ className: 'empty-icon' })
	 })
	    .bindTooltip(String(title), {
 	    permanent: true,
  	    direction: "center",
  	    className: "region-label"
	 })
	  .addTo(regionesLabelLayer);
          },
          style: { opacity: 0, fillOpacity: 0 }
        });
      });

    document.getElementById('toggleMunicipios').addEventListener('change', function(e) {
      if (e.target.checked) {
        map.addLayer(municipiosLabelLayer);
      } else {
        map.removeLayer(municipiosLabelLayer);
      }
    });

    document.getElementById('toggleRegiones').addEventListener('change', function(e) {
      if (e.target.checked) {
        map.addLayer(regionesLabelLayer);
      } else {
        map.removeLayer(regionesLabelLayer);
      }
    });

    // Edo_Hgo
    fetch('Edo_Hgo.geojson')
      .then(res => res.json())
      .then(data => {
        edoLayer = L.geoJSON(data, {
          style: { color: "rgb(255,0,0)", weight: 3, fillOpacity: 0 }
        }).addTo(map);
      });

    // Cargar TuExpTrans en memoria
    fetch('TuExpTrans.geojson')
      .then(res => res.json())
      .then(data => { informesData = data; });

    var legendDiv = document.getElementById('legend');
    var radios = document.getElementsByName('mapOption');

    function limpiarInformes() {
      if (informe1Layer) { map.removeLayer(informe1Layer); informe1Layer = null; }
      if (informe2Layer) { map.removeLayer(informe2Layer); informe2Layer = null; }
    }

    // Utilidad: convierte cualquier valor a número eliminando comas y símbolos
    function toNumberSafe(x) {
      if (x === null || x === undefined) return NaN;
      var s = String(x).replace(/[,]/g, '').replace(/[^\d.\-]/g, '');
      var v = parseFloat(s);
      return isNaN(v) ? NaN : v;
    }

    // Utilidad: construir diccionario desde tabla HTML dentro de properties
    function propsFromHtmlTable(properties) {
      var dict = {};
      for (var k in properties) {
        if (!properties.hasOwnProperty(k)) continue;
        var val = properties[k];
        if (typeof val !== 'string') dict[k] = val;
      }
      for (var key in properties) {
        if (!properties.hasOwnProperty(key)) continue;
        var html = properties[key];
        if (typeof html === 'string' && html.indexOf('<td') !== -1) {
          var container = document.createElement('div');
          container.innerHTML = html;
          var tds = container.querySelectorAll('td');
          for (var i = 0; i + 1 < tds.length; i += 2) {
            var name = tds[i].textContent.trim();
            var value = tds[i + 1].textContent.trim();
            dict[name] = value;
          }
        }
      }
      return dict;
    }

    // Obtener campo plano o extraído de tabla HTML
    function getField(f, fieldName) {
      if (f.properties && f.properties.hasOwnProperty(fieldName)) {
        return f.properties[fieldName];
      }
      var dict = propsFromHtmlTable(f.properties || {});
      return dict[fieldName];
    }

    // Estilo 1er informe
    function estiloInversion1(valorNum) {
      var valor = toNumberSafe(valorNum);
      if (isNaN(valor) || valor === 0) return { fillColor: "rgb(204,204,204)", color: "#333", weight: 1, fillOpacity: 1 };
      else if (valor >= 1 && valor <= 66000) return { fillColor: "rgb(245,230,210)", color: "#333", weight: 1, fillOpacity: 1 };
      else if (valor >= 66001 && valor <= 126000) return { fillColor: "rgb(225,200,150)", color: "#333", weight: 1, fillOpacity: 1 };
      else if (valor >= 126001 && valor <= 240000) return { fillColor: "rgb(180,150,100)", color: "#333", weight: 1, fillOpacity: 1 };
      else if (valor >= 240001 && valor <= 1122000) return { fillColor: "rgb(137,112,68)", color: "#333", weight: 1, fillOpacity: 1 };
      else return { fillColor: "#ccc", color: "#333", weight: 1, fillOpacity: 1 };
    }

    // Estilo 2do informe
    function estiloInversion2(valorNum) {
      var valor = toNumberSafe(valorNum);
      if (isNaN(valor) || valor === 0) return { fillColor: "rgb(204,204,204)", color: "#333", weight: 1, fillOpacity: 1 };
      else if (valor >= 1 && valor <= 247500) return { fillColor: "rgb(245,230,210)", color: "#333", weight: 1, fillOpacity: 1 };
      else if (valor >= 247501 && valor <= 517500) return { fillColor: "rgb(225,200,150)", color: "#333", weight: 1, fillOpacity: 1 };
      else if (valor >= 517501 && valor <= 1200000) return { fillColor: "rgb(180,150,100)", color: "#333", weight: 1, fillOpacity: 1 };
      else if (valor >= 1200001 && valor <= 3180000) return { fillColor: "rgb(137,112,68)", color: "#333", weight: 1, fillOpacity: 1 };
      else return { fillColor: "#ccc", color: "#333", weight: 1, fillOpacity: 1 };
    }

    // Selector con comportamiento toggle + leyendas
    Array.from(radios).forEach(radio => {
      radio.addEventListener('click', function(e) {
        if (radio.checked && radio.dataset.selected === "true") {
          limpiarInformes();
          legendDiv.style.display = "none";
          legendDiv.innerHTML = "<strong>INVERSIÓN</strong>";
          radio.checked = false;
          radio.dataset.selected = "false";

          municipiosLayer && municipiosLayer.bringToBack();
          regionesLayer && regionesLayer.bringToFront();
          edoLayer && edoLayer.bringToFront();
          return;
        }

        Array.from(radios).forEach(r => r.dataset.selected = "false");
        radio.dataset.selected = "true";

        limpiarInformes();

        if (e.target.value === 'informe1') {
          if (informesData) {
            informe1Layer = L.geoJSON(informesData, {
              style: f => estiloInversion1(getField(f, "ExpTra1eIn"))
            }).addTo(map);

            municipiosLayer && municipiosLayer.bringToBack();
            informe1Layer && informe1Layer.bringToFront();
            regionesLayer && regionesLayer.bringToFront();
            edoLayer && edoLayer.bringToFront();

            legendDiv.innerHTML = "<strong>INVERSIÓN</strong>";
            var segmentos1 = [
              { color: "rgb(204,204,204)", label: "Sin inversión" },
              { color: "rgb(245,230,210)", label: "$1 - $66,000" },
              { color: "rgb(225,200,150)", label: "$66,001 - $126,000" },
              { color: "rgb(180,150,100)", label: "$126,001 - $240,000" },
              { color: "rgb(137,112,68)", label: "$240,001 - $1,122,000" }
            ];
            segmentos1.forEach(s => {
              var row = document.createElement('div');
              var box = document.createElement('span');
              box.style.background = s.color;
              row.appendChild(box);
              row.appendChild(document.createTextNode(s.label));
              legendDiv.appendChild(row);
            });
            legendDiv.style.display = "block";
          }
        } else if (e.target.value === 'informe2') {
          if (informesData) {
            informe2Layer = L.geoJSON(informesData, {
              style: f => estiloInversion2(getField(f, "ExpTra2dIn"))
            }).addTo(map);

            municipiosLayer && municipiosLayer.bringToBack();
            informe2Layer && informe2Layer.bringToFront();
            regionesLayer && regionesLayer.bringToFront();
            edoLayer && edoLayer.bringToFront();

            legendDiv.innerHTML = "<strong>INVERSIÓN</strong>";
            var segmentos2 = [
              { color: "rgb(204,204,204)", label: "Sin inversión" },
              { color: "rgb(245,230,210)", label: "$1 - $247,500" },
              { color: "rgb(225,200,150)", label: "$247,501 - $517,500" },
              { color: "rgb(180,150,100)", label: "$517,501 - $1,200,000" },
              { color: "rgb(137,112,68)", label: "$1,200,001 - $3,180,000" }
            ];
            segmentos2.forEach(s => {
              var row = document.createElement('div');
              var box = document.createElement('span');
              box.style.background = s.color;
              row.appendChild(box);
              row.appendChild(document.createTextNode(s.label));
              legendDiv.appendChild(row);
            });
            legendDiv.style.display = "block";
          }
        }
      });
    });

  </script>
</body>
</html>
